name: Agent Self Improve

permissions:
  contents: write
  pull-requests: write

on:
  schedule:
    - cron: "30 4 * * *"
  workflow_dispatch:

jobs:
  self_improve:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install policy lint dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install jsonschema pytest

      - name: Self-improve regression tests
        run: python3 -m pytest -q tests/test_agent_self_improve.py

      - name: Governance and policy lint
        run: |
          ./scripts/agent_governance_check.sh
          python3 scripts/agent_policy_lint.py --strict --provider all --format json
          python3 scripts/check_provider_capabilities.py --strict --provider all --format json

      - name: Apply autonomous self-improvement
        run: |
          python3 scripts/agent_self_improve.py \
            --mode apply \
            --max-changes 5 \
            --touch AGENTS docs scripts \
            --emit-decision-log

      - name: Scope allowlist for autonomous changes
        run: |
          changed="$(git diff --name-only)"
          if [ -z "${changed}" ]; then
            echo "No changes generated by self-improve run."
            exit 0
          fi

          disallowed=""
          while IFS= read -r file; do
            case "${file}" in
              AGENTS.md|docs/*|scripts/*)
                ;;
              *)
                disallowed="${disallowed}${file}"$'\n'
                ;;
            esac
          done <<< "${changed}"

          if [ -n "${disallowed}" ]; then
            echo "Disallowed files modified by self-improve run:" >&2
            printf '%s\n' "${disallowed}" >&2
            exit 1
          fi

      - name: Detect semantic changes
        id: semantic_changes
        run: |
          if [ -n "$(git diff --name-only)" ]; then
            echo "has_changes=true" >> "${GITHUB_OUTPUT}"
          else
            echo "has_changes=false" >> "${GITHUB_OUTPUT}"
          fi

      - name: Preflight repository workflow permissions
        env:
          GH_TOKEN: ${{ secrets.MCP_GITHUB_PAT || secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if ! perms_json="$(gh api "repos/${GITHUB_REPOSITORY}/actions/permissions/workflow" 2>/dev/null)"; then
            echo "::warning::Could not inspect workflow permissions via API."
            echo "::warning::If PR creation fails, set Settings > Actions > General > Workflow permissions to 'Read and write permissions' and enable 'Allow GitHub Actions to create and approve pull requests'."
            exit 0
          fi

          default_perm="$(python3 -c 'import json,sys; print(json.loads(sys.argv[1]).get("default_workflow_permissions",""))' "${perms_json}")"
          can_approve="$(python3 -c 'import json,sys; print(str(json.loads(sys.argv[1]).get("can_approve_pull_request_reviews", False)).lower())' "${perms_json}")"

          if [ "${default_perm}" != "write" ]; then
            echo "::error::Repository workflow permission is '${default_perm}'. Set Settings > Actions > General > Workflow permissions to 'Read and write permissions'."
            exit 1
          fi

          if [ "${can_approve}" != "true" ]; then
            echo "::warning::'Allow GitHub Actions to create and approve pull requests' is disabled. Auto-merge may fail depending on branch protection."
          fi

      - name: Branch protection baseline
        env:
          GH_TOKEN: ${{ secrets.MCP_GITHUB_PAT || secrets.GITHUB_TOKEN }}
          BRANCH_PROTECTION_BRANCH: main
          BRANCH_PROTECTION_REQUIRED_CONTEXTS: frontend,backend,e2e_smoke,security,size_guard,llm_guards
          BRANCH_PROTECTION_REQUIRE_REVIEWS: "1"
          BRANCH_PROTECTION_REQUIRE_CONVERSATION_RESOLUTION: "1"
          BRANCH_PROTECTION_REQUIRE_SUPPORTED: ${{ vars.BRANCH_PROTECTION_REQUIRE_SUPPORTED || '0' }}
        run: ./scripts/check_branch_protection.sh

      - name: Create pull request
        if: steps.semantic_changes.outputs.has_changes == 'true'
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.MCP_GITHUB_PAT || secrets.GITHUB_TOKEN }}
          commit-message: "chore(agent): autonomous governance self-improvement"
          branch: "codex/agent-self-improve"
          delete-branch: true
          title: "chore(agent): autonomous governance self-improvement"
          body: |
            Automated governance update generated by `scripts/agent_self_improve.py`.

            - Runs policy lint and governance checks before patch generation.
            - Restricts modifications to AGENTS/docs/scripts scope.
            - Updates autonomous improvement backlog and related governance artifacts.
          labels: |
            automation
            governance

      - name: Enable auto-merge (if PR created)
        if: steps.semantic_changes.outputs.has_changes == 'true' && steps.cpr.outputs.pull-request-number != ''
        env:
          GH_TOKEN: ${{ secrets.MCP_GITHUB_PAT || secrets.GITHUB_TOKEN }}
        run: |
          gh pr merge "${{ steps.cpr.outputs.pull-request-number }}" --auto --squash --delete-branch
